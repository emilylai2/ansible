- name: Check System Password Policy
  hosts: all
  become: true
  tasks:

    - name: Detect OS type
      ansible.builtin.command: cat /etc/os-release
      register: os_type
      changed_when: false

    - name: Identify Distribution
      ansible.builtin.set_fact:
        is_ubuntu: "{{ 'ubuntu' in os_type.stdout | lower }}"
        is_rhel: "{{ 'rhel' in os_type.stdout | lower or 'centos' in os_type.stdout | lower }}"

    # âœ… æª¢æŸ¥å¯†ç¢¼é•·åº¦ & è¤‡é›œåº¦
    - name: Check pwquality.conf settings
      ansible.builtin.shell: grep -E '^(minlen|dcredit|ucredit|ocredit)' /etc/security/pwquality.conf || true
      register: pwquality_settings
      changed_when: false
      ignore_errors: true

    # âœ… æª¢æŸ¥å¯†ç¢¼åˆ°æœŸæ™‚é–“
    - name: Check password expiration settings
      ansible.builtin.shell: grep '^PASS_MAX_DAYS' /etc/login.defs | awk '{print $NF}'
      register: password_expiry
      changed_when: false
      ignore_errors: true

    # âœ… æª¢æŸ¥ç™»å…¥å¤±æ•—é–å®šæ©Ÿåˆ¶ï¼ˆUbuntu/RHELï¼‰
    - name: Check pam_tally2 or pam_faillock settings
      ansible.builtin.shell: grep -E 'pam_tally2|pam_faillock' /etc/pam.d/common-auth /etc/pam.d/system-auth || true
      register: pam_lockout
      changed_when: false
      ignore_errors: true

    # âœ… æª¢æŸ¥æ˜¯å¦ä½¿ç”¨ SHA-512 åŠ å¯†ï¼ˆRHELï¼‰
    - name: Check password hashing algorithm (RHEL)
      ansible.builtin.shell: authconfig --test | grep hashing || true
      register: password_hashing
      changed_when: false
      ignore_errors: true
      when: is_rhel

    # âœ… é¡¯ç¤ºæª¢æŸ¥çµæœ
    - name: Debug password policy settings
      ansible.builtin.debug:
        msg:
          - "ğŸ” **Operating System:** {{ 'Ubuntu' if is_ubuntu else 'RHEL/CentOS' if is_rhel else 'Unknown' }}"
          - "ğŸ” **pwquality.conf settings (é•·åº¦ & è¤‡é›œåº¦):** {{ pwquality_settings.stdout_lines | default('Not Found') }}"
          - "ğŸ” **Password Expiration (åˆ°æœŸæ™‚é–“):** {{ password_expiry.stdout | default('Not Set') }}"
          - "ğŸ” **Login Failure Lockout (ç™»å…¥å¤±æ•—é–å®š):** {{ pam_lockout.stdout | default('Not Configured') }}"
          - "ğŸ” **Password Hashing Algorithm (RHEL only):** {{ password_hashing.stdout | default('Not Found') }}"

    # âŒ å¦‚æœå¯†ç¢¼ç­–ç•¥æœªè¨­å®šï¼Œå‰‡å¤±æ•—
    - name: Fail if password policy is not configured properly
      ansible.builtin.fail:
        msg: "âŒ Password policy is NOT correctly configured!"
      when:
        - pwquality_settings.stdout == "" or pwquality_settings.stdout is not defined
        - password_expiry.stdout == "" or password_expiry.stdout is not defined
        - pam_lockout.stdout == "" or pam_lockout.stdout is not defined

