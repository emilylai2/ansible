- name: Ensure System Password Policy Compliance
  hosts: all
  become: true
  tasks:

    # 1ï¸âƒ£ ç¢ºèª OS é¡žåž‹ï¼ˆUbuntu / RHELï¼‰
    - name: Detect OS type
      ansible.builtin.command: cat /etc/os-release
      register: os_type
      changed_when: false

    - name: Identify Distribution
      ansible.builtin.set_fact:
        is_ubuntu: "{{ 'ubuntu' in os_type.stdout | lower }}"
        is_rhel: "{{ 'rhel' in os_type.stdout | lower or 'centos' in os_type.stdout | lower }}"

    # 2ï¸âƒ£ ç¢ºä¿ /etc/security/pwquality.conf å­˜åœ¨ï¼ˆå¯†ç¢¼é•·åº¦ & è¤‡é›œåº¦ï¼‰
    - name: Ensure /etc/security/pwquality.conf exists
      ansible.builtin.file:
        path: /etc/security/pwquality.conf
        state: touch
        mode: '0644'

    - name: Apply password complexity rules in pwquality.conf
      ansible.builtin.lineinfile:
        path: /etc/security/pwquality.conf
        line: "{{ item }}"
        create: yes
      loop:
        - "minlen = 12"
        - "dcredit = -1"
        - "ucredit = -1"
        - "lcredit = -1"
        - "ocredit = -1"

    # 3ï¸âƒ£ ç¢ºä¿å¯†ç¢¼åˆ°æœŸæ™‚é–“ä¸è¶…éŽ 90 å¤©
    - name: Check current password expiration setting
      ansible.builtin.shell: grep '^PASS_MAX_DAYS' /etc/login.defs | awk '{print $NF}'
      register: password_expiry
      changed_when: false
      ignore_errors: true

    - name: Ensure password expiration is set to 90 days
      ansible.builtin.lineinfile:
        path: /etc/login.defs
        regexp: '^PASS_MAX_DAYS'
        line: 'PASS_MAX_DAYS   90'
      when: password_expiry.stdout | default('1000') | int > 90

    # 4ï¸âƒ£ ç¢ºä¿ PAM å•Ÿç”¨äº†ç™»å…¥å¤±æ•—éŽ–å®šï¼ˆé˜²æš´åŠ›ç ´è§£ï¼‰
    - name: Check pam_faillock or pam_tally2 settings
      ansible.builtin.shell: grep -E 'pam_tally2|pam_faillock' /etc/pam.d/common-auth /etc/pam.d/system-auth || true
      register: pam_lockout
      changed_when: false
      ignore_errors: true

    - name: Enable login failure lockout (for Ubuntu & RHEL)
      ansible.builtin.lineinfile:
        path: "{{ '/etc/pam.d/common-auth' if is_ubuntu else '/etc/pam.d/system-auth' }}"
        line: "auth required pam_tally2.so deny=5 unlock_time=600"
        create: yes
      when: pam_lockout.stdout == ""

    # 5ï¸âƒ£ æª¢æŸ¥å¯†ç¢¼é›œæ¹Šæ¼”ç®—æ³•æ˜¯å¦ç‚º SHA-512
    - name: Check password hashing algorithm
      ansible.builtin.shell: |
        if [ -f /etc/login.defs ]; then
          grep '^ENCRYPT_METHOD' /etc/login.defs | awk '{print $NF}'
        elif command -v authconfig >/dev/null 2>&1; then
          authconfig --test | grep hashing | awk '{print $NF}'
        elif command -v authselect >/dev/null 2>&1; then
          authselect current | grep sha512 && echo "sha512"
        else
          echo "Unknown"
        fi
      register: password_hashing
      changed_when: false
      ignore_errors: true

    - name: Debug password hashing output
      ansible.builtin.debug:
        msg: "ðŸ” **Password Hashing Algorithm:** {{ password_hashing.stdout | default('Not Found') }}"

    - name: Ensure SHA-512 hashing is enabled
      ansible.builtin.shell: |
        if command -v authconfig >/dev/null 2>&1; then
          authconfig --passalgo=sha512 --update
        elif command -v authselect >/dev/null 2>&1; then
          authselect select sssd with-sha512 --force
        else
          echo "No supported command found"
        fi
      when: password_hashing.stdout | string != "SHA512"
      ignore_errors: true

    - name: Ensure SHA-512 is set in /etc/login.defs
      ansible.builtin.lineinfile:
        path: /etc/login.defs
        regexp: '^ENCRYPT_METHOD'
        line: 'ENCRYPT_METHOD SHA512'
        create: yes

    # 6ï¸âƒ£ æœ€çµ‚ç¢ºèª & Debug è¨Šæ¯
    - name: Debug password policy settings
      ansible.builtin.debug:
        msg:
          - "ðŸ” **Operating System:** {{ 'Ubuntu' if is_ubuntu else 'RHEL/CentOS' if is_rhel else 'Unknown' }}"
          - "ðŸ” **pwquality.conf settings (é•·åº¦ & è¤‡é›œåº¦):** minlen = 12, dcredit = -1, ucredit = -1, ocredit = -1"
          - "ðŸ” **Password Expiration (åˆ°æœŸæ™‚é–“):** {{ password_expiry.stdout | default('Unknown') }}"
          - "ðŸ” **Login Failure Lockout:** {{ 'Enabled' if pam_lockout.stdout != '' else 'Not Configured' }}"
          - "ðŸ” **Password Hashing Algorithm:** {{ password_hashing.stdout | default('Not Found') }}"

    # 7ï¸âƒ£ å¦‚æžœæª¢æŸ¥ä¸é€šéŽï¼Œå‰‡è®“ Playbook å¤±æ•—
    - name: Fail if password policy is not correctly configured
      ansible.builtin.fail:
        msg: "âŒ Password policy is NOT correctly configured!"
      when:
        - password_expiry.stdout | default('1000') | int > 90
        - pam_lockout.stdout is not defined or pam_lockout.stdout == ""

